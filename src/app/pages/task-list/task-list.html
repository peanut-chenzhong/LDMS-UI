<div class="page-container">
  <!-- 页面标题 -->
  <div class="page-header">
    <h1 class="page-title">Hudi Table Analysis Tasks</h1>
    <p class="page-desc">View and manage Hudi table analysis task execution status.</p>
  </div>

  <!-- 操作栏 -->
  <div class="action-bar">
    <button tiButton type="button" color="primary" (click)="openCreateModal()">
      <span class="btn-icon">+</span> 新增任务
    </button>
  </div>

  <!-- 筛选栏 -->
  <div class="filter-bar">
    <div class="filter-controls">
      <div class="filter-item">
        <label class="filter-label">任务状态</label>
        <ti-select
          [(ngModel)]="selectedStatus"
          [options]="statusOptions"
          [clearable]="true"
          placeholder="选择状态"
          (ngModelChange)="onStatusFilterChange()"
          style="width: 140px;">
        </ti-select>
      </div>
      <div class="filter-item">
        <label class="filter-label">任务名</label>
        <input 
          type="text" 
          class="filter-input" 
          [(ngModel)]="searchTaskName"
          (keyup.enter)="onSearch()"
          placeholder="输入任务名搜索">
      </div>
      <div class="filter-item">
        <label class="filter-label">Database</label>
        <ti-select
          [(ngModel)]="selectedSearchDatabase"
          [options]="allDatabases"
          [searchable]="true"
          [clearable]="true"
          placeholder="选择或输入database"
          style="width: 180px;">
        </ti-select>
      </div>
      <div class="filter-item">
        <label class="filter-label">TableName</label>
        <ti-select
          [(ngModel)]="selectedSearchTableName"
          [options]="allTableNames"
          [searchable]="true"
          [clearable]="true"
          placeholder="选择或输入表名"
          style="width: 180px;">
        </ti-select>
      </div>
    </div>
    <div class="filter-actions">
      <button tiButton type="button" color="primary" (click)="onSearch()">Search</button>
      <button tiButton type="button" (click)="onReset()">Reset</button>
    </div>
  </div>

  <!-- 表格区域 -->
  <div class="table-container">
    <ti-table
      [srcData]="srcData"
      [(displayedData)]="displayedTasks">
      <table>
        <thead>
          <tr>
            <th width="160">任务名</th>
            <th width="160" class="sortable" (click)="onSort('createTime')">
              创建时间
              <span class="sort-icon" [class.active]="sortField === 'createTime'">
                @if (sortField === 'createTime') {
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                } @else {
                  ↕
                }
              </span>
            </th>
            <th width="100" class="sortable" (click)="onSort('status')">
              任务状态
              <span class="sort-icon" [class.active]="sortField === 'status'">
                @if (sortField === 'status') {
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                } @else {
                  ↕
                }
              </span>
            </th>
            <th width="80" class="sortable" (click)="onSort('tableCount')">
              表数量
              <span class="sort-icon" [class.active]="sortField === 'tableCount'">
                @if (sortField === 'tableCount') {
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                } @else {
                  ↕
                }
              </span>
            </th>
            <th width="160" class="sortable" (click)="onSort('startTime')">
              开始时间
              <span class="sort-icon" [class.active]="sortField === 'startTime'">
                @if (sortField === 'startTime') {
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                } @else {
                  ↕
                }
              </span>
            </th>
            <th width="160" class="sortable" (click)="onSort('endTime')">
              完成时间
              <span class="sort-icon" [class.active]="sortField === 'endTime'">
                @if (sortField === 'endTime') {
                  {{ sortDirection === 'asc' ? '↑' : '↓' }}
                } @else {
                  ↕
                }
              </span>
            </th>
            <th width="200">任务 AppID</th>
            <th width="200">操作</th>
          </tr>
        </thead>
        <tbody>
          @for (task of displayedTasks; track task.id) {
            <tr class="task-row" [class.expanded]="isTaskExpanded(task)" (click)="toggleTaskRow(task)">
              <td>
                <span class="task-name">{{ task.taskName }}</span>
              </td>
              <td>{{ task.createTime }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(task.status)">
                  {{ getStatusText(task.status) }}
                </span>
              </td>
              <td>
                <span class="tables-count" (click)="openTablesModal(task, $event); $event.stopPropagation()">
                  {{ task.tables.length }}
                </span>
              </td>
              <td>{{ task.startTime }}</td>
              <td>{{ task.endTime }}</td>
              <td>
                <span class="app-id" [title]="task.appId">{{ task.appId }}</span>
              </td>
              <td>
                <div class="action-buttons" (click)="$event.stopPropagation()">
                  <button 
                    class="btn-action btn-view" 
                    [class.disabled]="!canViewReport(task)"
                    [disabled]="!canViewReport(task)"
                    (click)="canViewReport(task) && viewReport(task)">
                    查看报告
                  </button>
                  @if (canStart(task)) {
                    <button 
                      class="btn-action btn-start" 
                      (click)="startTask(task)">
                      启动
                    </button>
                  }
                  @if (canStop(task)) {
                    <button 
                      class="btn-action btn-stop" 
                      (click)="stopTask(task)">
                      停止
                    </button>
                  }
                  <button 
                    class="btn-action btn-delete" 
                    [class.disabled]="!canDelete(task)"
                    [disabled]="!canDelete(task)"
                    (click)="canDelete(task) && deleteTask(task)">
                    删除
                  </button>
                </div>
              </td>
            </tr>
            @if (isTaskExpanded(task)) {
              <tr class="task-detail-row">
                <td colspan="8" class="task-detail-cell">
                  <div class="execution-list">
                    <div class="execution-list-header">
                      <span class="execution-list-title">执行历史记录</span>
                    </div>
                    @if (task.executions && task.executions.length > 0) {
                      @for (execution of task.executions; track execution.id) {
                        <div class="execution-item">
                          <div class="execution-details">
                            <div class="execution-detail-row">
                              <div class="execution-detail-item">
                                <span class="execution-label">任务 AppID:</span>
                                <span class="execution-value">{{ execution.appId }}</span>
                              </div>
                              <div class="execution-detail-item">
                                <span class="execution-label">开始时间:</span>
                                <span class="execution-value">{{ execution.startTime }}</span>
                              </div>
                              <div class="execution-detail-item">
                                <span class="execution-label">完成时间:</span>
                                <span class="execution-value">{{ execution.endTime }}</span>
                              </div>
                              <div class="execution-detail-item">
                                <span class="execution-label">状态:</span>
                                <span class="status-badge" [ngClass]="getStatusClass(execution.status)">
                                  {{ getStatusText(execution.status) }}
                                </span>
                              </div>
                              <div class="execution-detail-item execution-actions">
                                @if (execution.status === 'completed') {
                                  <button 
                                    class="btn-action btn-view" 
                                    (click)="viewReportForExecution(task, execution)">
                                    查看报告
                                  </button>
                                }
                              </div>
                            </div>
                          </div>
                        </div>
                      }
                    } @else {
                      <div class="no-executions">暂无执行记录</div>
                    }
                  </div>
                </td>
              </tr>
            }
          } @empty {
            <tr>
              <td colspan="8" class="empty-cell">暂无任务数据</td>
            </tr>
          }
        </tbody>
      </table>
    </ti-table>

    <!-- 分页控件 -->
    <ti-pagination
      [(currentPage)]="pagination.currentPage"
      [pageSize]="pagination.pageSize"
      [totalNumber]="pagination.totalNumber"
      (pageUpdate)="onPageUpdate($event)">
    </ti-pagination>
  </div>

  <!-- 表列表弹窗 -->
  @if (showTablesModal) {
    <div class="modal-overlay" (click)="closeTablesModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">分析表列表</h3>
          <button class="modal-close" (click)="closeTablesModal()">✕</button>
        </div>
        <div class="modal-body">
          <p class="modal-task-name">任务: {{ modalTaskName }}</p>
          <div class="tables-list">
            @for (table of modalTables; track table; let i = $index) {
              <div class="table-item">
                <span class="table-index">{{ i + 1 }}</span>
                <span class="table-name">{{ table }}</span>
              </div>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button tiButton type="button" (click)="closeTablesModal()">关闭</button>
        </div>
      </div>
    </div>
  }

  <!-- 新增任务弹窗 -->
  @if (showCreateModal) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal-content modal-create" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">新增分析任务</h3>
          <button class="modal-close" (click)="closeCreateModal()">✕</button>
        </div>
        <div class="modal-body">
          <!-- 任务名称输入 -->
          <div class="form-section">
            <label class="form-label">任务名称 <span class="required-mark">*</span></label>
            <input 
              type="text" 
              class="form-input"
              [(ngModel)]="newTaskName"
              placeholder="请输入任务名称"
              maxlength="100">
          </div>

          <!-- 分析项选择 -->
          <div class="form-section">
            <label class="form-label">分析项</label>
            <div class="checkbox-group">
              @for (opt of analysisOptions; track opt.key) {
                <label class="checkbox-item">
                  <input type="checkbox" [(ngModel)]="opt.checked">
                  <span class="checkbox-label">{{ opt.label }}</span>
                </label>
              }
            </div>
            <!-- 分区存储分析（带模式选择） -->
            <div class="partition-analysis-row">
              <label class="checkbox-item">
                <input type="checkbox" [(ngModel)]="partitionAnalysisEnabled">
                <span class="checkbox-label">分区存储分析</span>
              </label>
              <select 
                class="partition-mode-select" 
                [(ngModel)]="partitionAnalysisMode"
                [disabled]="!partitionAnalysisEnabled">
                @for (mode of partitionAnalysisModes; track mode.value) {
                  <option [value]="mode.value">{{ mode.label }}</option>
                }
              </select>
              @if (partitionAnalysisEnabled && partitionAnalysisMode === 'specified_commit') {
                <input 
                  type="text" 
                  class="commit-time-input"
                  [(ngModel)]="specifiedCommitTime"
                  placeholder="yyyyMMddHHmmssSSS"
                  maxlength="17">
              }
            </div>
          </div>

          <!-- 数据库选择 -->
          <div class="form-section">
            <label class="form-label">选择 Database</label>
            <select class="form-select" [(ngModel)]="selectedDatabase" (ngModelChange)="onDatabaseChange()">
              <option value="">请选择数据库</option>
              @for (db of databaseList; track db) {
                <option [value]="db">{{ db }}</option>
              }
            </select>
          </div>

          <!-- 表选择 -->
          @if (selectedDatabase) {
            <div class="form-section">
              <div class="form-label-row">
                <label class="form-label">选择分析表</label>
                <button class="btn-select-all" (click)="toggleAllTables()">
                  {{ selectedTables.length === availableTables.length ? '取消全选' : '全选' }}
                </button>
              </div>
              <div class="table-search-box">
                <input 
                  type="text" 
                  class="table-search-input"
                  [(ngModel)]="tableSearchKeyword"
                  placeholder="输入表名搜索...">
              </div>
              <div class="tables-select-box">
                @for (table of filteredAvailableTables; track table) {
                  <label class="table-checkbox-item" [class.selected]="isTableSelected(table)">
                    <input 
                      type="checkbox" 
                      [checked]="isTableSelected(table)"
                      (change)="toggleTableSelection(table)">
                    <span class="table-checkbox-name">{{ table }}</span>
                  </label>
                } @empty {
                  <div class="no-tables">未找到匹配的表</div>
                }
              </div>
              <div class="selected-count">
                已选择 {{ selectedTables.length }} / {{ availableTables.length }} 张表
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button tiButton type="button" (click)="closeCreateModal()">取消</button>
          <button tiButton type="button" color="primary" (click)="submitCreateTask()">提交</button>
        </div>
      </div>
    </div>
  }
</div>
