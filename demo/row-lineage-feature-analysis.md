# Apache Iceberg Row Lineage ç‰¹æ€§è¯¦è§£

> æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» Apache Iceberg V3 ä¸­çš„ Row Lineageï¼ˆè¡Œçº§è¡€ç¼˜è¿½è¸ªï¼‰ç‰¹æ€§ï¼ŒåŒ…æ‹¬å…¶è®¾è®¡åŸç†ã€å®ç°æœºåˆ¶ã€ä½¿ç”¨æ–¹æ³•ä»¥åŠå®Œæ•´çš„ç¤ºä¾‹ã€‚

---

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#2-æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¾è®¡åŸç†](#3-è®¾è®¡åŸç†)
4. [å®ç°æœºåˆ¶è¯¦è§£](#4-å®ç°æœºåˆ¶è¯¦è§£)
5. [å®Œæ•´ç¤ºä¾‹](#5-å®Œæ•´ç¤ºä¾‹)
6. [ä½¿ç”¨åœºæ™¯](#6-ä½¿ç”¨åœºæ™¯)
7. [é™åˆ¶ä¸æ³¨æ„äº‹é¡¹](#7-é™åˆ¶ä¸æ³¨æ„äº‹é¡¹)
8. [è¡¨å‡çº§æŒ‡å—](#8-è¡¨å‡çº§æŒ‡å—)
9. [å¼•æ“æ”¯æŒ](#9-å¼•æ“æ”¯æŒ)
10. [å‚è€ƒèµ„æ–™](#10-å‚è€ƒèµ„æ–™)

---

## 1. æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Row Lineageï¼Ÿ

**Row Lineageï¼ˆè¡Œçº§è¡€ç¼˜è¿½è¸ªï¼‰** æ˜¯ Apache Iceberg åœ¨ **ç‰ˆæœ¬è§„èŒƒ V3** ä¸­æ–°å¢çš„æ ¸å¿ƒç‰¹æ€§ï¼Œç”¨äºè¿½è¸ªè¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®ä»åˆ›å»ºã€ä¿®æ”¹ç›´åˆ°æœ€æ–°çŠ¶æ€çš„å®Œæ•´å…ƒæ•°æ®ä¿¡æ¯ã€‚

å®ƒä¸ºæ•°æ®æ¹–ä¸­çš„æ¯ä¸€è¡Œæ•°æ®æä¾›äº†"èº«ä»½è¯"å’Œ"å˜æ›´å±¥å†"ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ï¼š
- çŸ¥é“æ¯è¡Œæ•°æ®çš„å”¯ä¸€æ ‡è¯†
- è¿½è¸ªæ¯è¡Œæ•°æ®æœ€åä¸€æ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ç‚¹
- å®ç°é«˜æ•ˆçš„å¢é‡æ•°æ®å¤„ç†

### 1.2 V3 æ–°ç‰¹æ€§ä¸€è§ˆ

Row Lineage æ˜¯ Iceberg V3 çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒV3 è¿˜åŒ…æ‹¬ä»¥ä¸‹æ–°ç‰¹æ€§ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| æ–°æ•°æ®ç±»å‹ | çº³ç§’çº§æ—¶é—´æˆ³ã€unknownã€variantã€geometryã€geography |
| åˆ—é»˜è®¤å€¼ | æ”¯æŒä¸ºåˆ—è®¾ç½®é»˜è®¤å€¼ |
| å¤šå‚æ•°è½¬æ¢ | åˆ†åŒºå’Œæ’åºæ”¯æŒå¤šå‚æ•°è½¬æ¢å‡½æ•° |
| **Row Lineage** | è¡Œçº§è¡€ç¼˜è¿½è¸ª |
| åˆ é™¤å‘é‡ | äºŒè¿›åˆ¶åˆ é™¤å‘é‡ï¼ˆDeletion Vectorsï¼‰ |
| è¡¨åŠ å¯†å¯†é’¥ | æ”¯æŒè¡¨çº§åˆ«çš„åŠ å¯†å¯†é’¥ |

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 æ ¸å¿ƒå…ƒæ•°æ®å­—æ®µ

Row Lineage å¼•å…¥äº†ä¸¤ä¸ªå…³é”®çš„å…ƒæ•°æ®åˆ—ï¼š

| å­—æ®µå | ç±»å‹ | Field ID | è¯´æ˜ |
|--------|------|----------|------|
| `_row_id` | `long` | 2147483540 | è¡¨ä¸­æ¯è¡Œçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œåœ¨è¡Œé¦–æ¬¡å†™å…¥æ—¶åˆ†é…ï¼Œåç»­ä¿æŒä¸å˜ |
| `_last_updated_sequence_number` | `long` | 2147483539 | æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥è¡Œçš„æäº¤åºåˆ—å· |

### 2.2 è¡¨çº§å…ƒæ•°æ®å­—æ®µ

| å­—æ®µå | è¯´æ˜ |
|--------|------|
| `next-row-id` | ä¸‹ä¸€ä¸ªå¿«ç…§å¼€å§‹æ—¶ï¼Œå°†ä¸ºæ–°è¡Œåˆ†é…çš„ row_id èµ·å§‹å€¼ |

### 2.3 å¿«ç…§çº§å…ƒæ•°æ®å­—æ®µ

| å­—æ®µå | è¯´æ˜ |
|--------|------|
| `first-row-id` | è¯¥å¿«ç…§çš„èµ·å§‹ row_idï¼Œç­‰äºåˆ›å»ºå¿«ç…§æ—¶è¡¨çš„ `next-row-id` |
| `added-rows` | è¯¥å¿«ç…§ä¸­æ–°å¢çš„è¡Œæ•° |

### 2.4 Manifest å’Œæ•°æ®æ–‡ä»¶çº§å­—æ®µ

| å±‚çº§ | å­—æ®µå | è¯´æ˜ |
|------|--------|------|
| Manifest | `first_row_id` | è¯¥ manifest çš„èµ·å§‹ row_id |
| Data File | `first_row_id` | è¯¥æ•°æ®æ–‡ä»¶çš„èµ·å§‹ row_id |

---

## 3. è®¾è®¡åŸç†

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ Row Lineageï¼Ÿ

#### é—®é¢˜1ï¼šè¡Œçº§å˜æ›´è¿½è¸ªå›°éš¾

åœ¨ Iceberg V2 ä¸­ï¼Œè¦è¿½è¸ªæŸè¡Œçš„å˜æ›´å†å²ï¼Œéœ€è¦ï¼š
- å¯¹æ¯”å¤šä¸ªå¿«ç…§
- ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰ä¸»é”®
- ä¾èµ–ç­‰å€¼åˆ é™¤ï¼ˆEquality Deletesï¼‰

è¿™äº›æ–¹æ³•éƒ½æœ‰å±€é™æ€§ï¼Œä¸”æ•ˆç‡ä¸é«˜ã€‚

#### é—®é¢˜2ï¼šå¢é‡å¤„ç†æˆæœ¬é«˜

å¦‚æœä¸‹æ¸¸ç³»ç»Ÿåªéœ€è¦å¤„ç†å˜æ›´çš„æ•°æ®ï¼Œä»¥å‰éœ€è¦ï¼š
```sql
-- V2 ä¸­çš„åšæ³•ï¼šæ¯”å¯¹ä¸¤ä¸ªå¿«ç…§
SELECT * FROM table VERSION AS OF snapshot_2
EXCEPT
SELECT * FROM table VERSION AS OF snapshot_1
```

è¿™éœ€è¦æ‰«æå¤§é‡æ•°æ®ï¼Œæ•ˆç‡å¾ˆä½ã€‚

#### é—®é¢˜3ï¼šå®¡è®¡åˆè§„éœ€æ±‚

é‡‘èã€åŒ»ç–—ã€æ”¿åºœç­‰è¡Œä¸šéœ€è¦çŸ¥é“ï¼š
- æ¯æ¡æ•°æ®ä½•æ—¶å†™å…¥
- æ¯æ¡æ•°æ®ä½•æ—¶è¢«ä¿®æ”¹
- æ•°æ®çš„å®Œæ•´å˜æ›´å±¥å†

### 3.2 è®¾è®¡ç›®æ ‡

1. **å”¯ä¸€æ€§**ï¼šæ¯è¡Œæ•°æ®æœ‰å…¨å±€å”¯ä¸€çš„æ ‡è¯†ç¬¦
2. **ç¨³å®šæ€§**ï¼šè¡Œ ID åœ¨è¡Œçš„ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜
3. **å¯è¿½æº¯æ€§**ï¼šå¯ä»¥è¿½è¸ªæ¯è¡Œçš„æœ€åä¿®æ”¹æ—¶é—´
4. **é«˜æ€§èƒ½**ï¼šä¸å½±å“å†™å…¥å’Œè¯»å–æ€§èƒ½
5. **å…¼å®¹æ€§**ï¼šæ”¯æŒä¹è§‚å¹¶å‘æ§åˆ¶å’Œé‡è¯•æœºåˆ¶

---

## 4. å®ç°æœºåˆ¶è¯¦è§£

### 4.1 ç»§æ‰¿ï¼ˆInheritanceï¼‰æœºåˆ¶

è¿™æ˜¯ Row Lineage æœ€æ ¸å¿ƒçš„è®¾è®¡åˆ›æ–°ã€‚

#### ä¸ºä»€ä¹ˆä¸ç›´æ¥å†™å…¥ç¡®å®šå€¼ï¼Ÿ

åœ¨ Iceberg çš„ä¹è§‚å¹¶å‘æ¨¡å‹ä¸­ï¼š
1. å†™å…¥æ•°æ®æ—¶ï¼Œè¿˜ä¸çŸ¥é“æœ€ç»ˆçš„ commit åºåˆ—å·
2. ä¸çŸ¥é“ row_id çš„ç¡®åˆ‡èµ·å§‹å€¼ï¼ˆå¯èƒ½è¢«å…¶ä»–å¹¶å‘å†™å…¥å ç”¨ï¼‰
3. å¦‚æœæäº¤å¤±è´¥éœ€è¦é‡è¯•ï¼Œç¡®å®šå€¼éœ€è¦é‡æ–°è®¡ç®—å’Œé‡å†™

#### ç»§æ‰¿æœºåˆ¶å¦‚ä½•å·¥ä½œï¼Ÿ

```
å†™å…¥æ—¶ï¼šå°† _row_id å’Œ _last_updated_sequence_number è®¾ä¸º null
         â†“
æäº¤æ—¶ï¼šåœ¨å…ƒæ•°æ®å±‚é¢è®°å½• first-row-id å’Œ sequence_number
         â†“
è¯»å–æ—¶ï¼šé€šè¿‡ç»§æ‰¿æœºåˆ¶è®¡ç®—å®é™…å€¼
         _row_id = first_row_id + _posï¼ˆè¡Œåœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ï¼‰
         _last_updated_sequence_number = manifest_entry.sequence_number
```

### 4.2 Row ID åˆ†é…å±‚çº§

Row ID çš„åˆ†é…éµå¾ªä»è¡¨åˆ°è¡Œçš„å±‚çº§ç»“æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table                                                        â”‚
â”‚   next-row-id: 1000 (ä¸‹ä¸€ä¸ªå¯ç”¨çš„ row_id)                    â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Snapshot                                                 â”‚ â”‚
â”‚ â”‚   first-row-id: 1000                                     â”‚ â”‚
â”‚ â”‚   added-rows: 200                                        â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚ â”‚ Manifest List                                      â”‚   â”‚ â”‚
â”‚ â”‚ â”‚                                                    â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ Manifest 1                                   â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   first_row_id: 1000                         â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   added_rows_count: 100                      â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚                                              â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ DataFile A                              â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   first_row_id: null â†’ 1000             â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   record_count: 50                      â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚                                         â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   Row 0: _row_id = 1000 + 0 = 1000      â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   Row 1: _row_id = 1000 + 1 = 1001      â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   ...                                   â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   Row 49: _row_id = 1000 + 49 = 1049    â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚                                              â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ DataFile B                              â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   first_row_id: null â†’ 1050             â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   record_count: 50                      â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚                                         â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   Row 0: _row_id = 1050 + 0 = 1050      â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚   ...                                   â”‚ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚                                                    â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ Manifest 2                                   â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   first_row_id: 1100                         â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   added_rows_count: 100                      â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â”‚   ...                                        â”‚   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ æäº¤å: next-row-id æ›´æ–°ä¸º 1200                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ä¸åŒæ“ä½œçš„å¤„ç†è§„åˆ™

| æ“ä½œç±»å‹ | `_row_id` å¤„ç† | `_last_updated_sequence_number` å¤„ç† |
|----------|----------------|--------------------------------------|
| **INSERTï¼ˆæ–°å¢è¡Œï¼‰** | è®¾ä¸º `null`ï¼Œè¯»å–æ—¶é€šè¿‡ç»§æ‰¿è®¡ç®— | è®¾ä¸º `null`ï¼Œè¯»å–æ—¶ç»§æ‰¿ sequence_number |
| **UPDATEï¼ˆä¿®æ”¹è¡Œï¼‰** | **ä¿ç•™åŸå€¼**ä¸å˜ | è®¾ä¸º `null`ï¼Œè¯»å–æ—¶ç»§æ‰¿æ–°çš„ sequence_number |
| **ç§»åŠ¨è¡Œï¼ˆcompactionï¼‰** | **ä¿ç•™åŸå€¼**ä¸å˜ | **ä¿ç•™åŸå€¼**ä¸å˜ |
| **DELETEï¼ˆåˆ é™¤è¡Œï¼‰** | ä¸é€‚ç”¨ | ä¸é€‚ç”¨ |
| **Equality Delete** | è§†ä¸ºåˆ é™¤æ—§è¡Œ+æ’å…¥æ–°è¡Œï¼Œæ–°è¡Œè·å¾—æ–°çš„ row_id | æ–°è¡Œè·å¾—æ–°çš„ sequence_number |

### 4.4 å¹¶å‘å†²çªå¤„ç†

å½“å‘ç”Ÿä¹è§‚å¹¶å‘å†²çªæ—¶ï¼š

```
æ—¶é—´çº¿ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

Writer A                    Writer B
   â”‚                           â”‚
   â”œâ”€ è¯»å– next-row-id=1000    â”‚
   â”‚                           â”œâ”€ è¯»å– next-row-id=1000
   â”‚                           â”‚
   â”œâ”€ å†™å…¥æ•°æ®æ–‡ä»¶              â”‚
   â”‚  first_row_id=null        â”œâ”€ å†™å…¥æ•°æ®æ–‡ä»¶
   â”‚  (è®¡åˆ’ä½¿ç”¨1000èµ·)          â”‚  first_row_id=null
   â”‚                           â”‚  (è®¡åˆ’ä½¿ç”¨1000èµ·)
   â”‚                           â”‚
   â”‚                           â”œâ”€ æäº¤æˆåŠŸï¼
   â”‚                           â”‚  next-row-id æ›´æ–°ä¸º 1050
   â”‚                           â”‚
   â”œâ”€ å°è¯•æäº¤...              â”‚
   â”‚  æ£€æµ‹åˆ°å†²çªï¼              â”‚
   â”‚                           â”‚
   â”œâ”€ é‡è¯•æäº¤                  â”‚
   â”‚  é‡æ–°è¯»å– next-row-id=1050 â”‚
   â”‚  é‡å†™ manifest list        â”‚
   â”‚  first_row_id æ›´æ–°ä¸º 1050  â”‚
   â”‚                           â”‚
   â”œâ”€ æäº¤æˆåŠŸï¼                â”‚
   â”‚  next-row-id æ›´æ–°ä¸º 1100   â”‚
   â–¼                           â–¼
```

**å…³é”®ç‚¹**ï¼š
1. æ•°æ®æ–‡ä»¶ä¸éœ€è¦é‡å†™ï¼ˆfirst_row_id å†™çš„æ˜¯ nullï¼‰
2. åªéœ€è¦é‡å†™ manifest listï¼ˆæˆæœ¬å¾ˆä½ï¼‰
3. æœ€ç»ˆæ‰€æœ‰è¡Œéƒ½ä¼šè·å¾—å”¯ä¸€çš„ row_id

---

## 5. å®Œæ•´ç¤ºä¾‹

### 5.1 åœºæ™¯æè¿°

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·è®¢å•è¡¨ï¼Œéœ€è¦è¿½è¸ªè®¢å•çš„å˜æ›´å†å²ã€‚

### 5.2 åˆ›å»º V3 è¡¨

```sql
-- ä½¿ç”¨ Spark SQL åˆ›å»º Iceberg V3 è¡¨
CREATE TABLE orders (
    order_id BIGINT,
    user_id BIGINT,
    product_name STRING,
    quantity INT,
    price DECIMAL(10, 2),
    status STRING,
    created_at TIMESTAMP
) USING iceberg
TBLPROPERTIES ('format-version' = '3');
```

### 5.3 åˆå§‹æ•°æ®å†™å…¥

```sql
-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO orders VALUES
    (1001, 100, 'iPhone 15', 1, 7999.00, 'PENDING', timestamp'2024-01-15 10:00:00'),
    (1002, 101, 'MacBook Pro', 1, 14999.00, 'PENDING', timestamp'2024-01-15 10:05:00'),
    (1003, 102, 'AirPods Pro', 2, 1999.00, 'PENDING', timestamp'2024-01-15 10:10:00');
```

**æ­¤æ—¶è¡¨çš„çŠ¶æ€ï¼š**

```
Table Metadata:
  next-row-id: 3

Snapshot 1 (sequence_number: 1):
  first-row-id: 0
  added-rows: 3

æ•°æ®å†…å®¹ï¼ˆåŒ…å«éšå¼çš„ Row Lineage å­—æ®µï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_id â”‚ user_id â”‚ product_nameâ”‚ quantity â”‚ price    â”‚ status  â”‚ created_at          â”‚ _row_id â”‚ _last_updated_sequence_number    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1001     â”‚ 100     â”‚ iPhone 15   â”‚ 1        â”‚ 7999.00  â”‚ PENDING â”‚ 2024-01-15 10:00:00 â”‚ 0       â”‚ 1                                â”‚
â”‚ 1002     â”‚ 101     â”‚ MacBook Pro â”‚ 1        â”‚ 14999.00 â”‚ PENDING â”‚ 2024-01-15 10:05:00 â”‚ 1       â”‚ 1                                â”‚
â”‚ 1003     â”‚ 102     â”‚ AirPods Pro â”‚ 2        â”‚ 1999.00  â”‚ PENDING â”‚ 2024-01-15 10:10:00 â”‚ 2       â”‚ 1                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 æ›´æ–°è®¢å•çŠ¶æ€

```sql
-- è®¢å• 1001 å·²å‘è´§
UPDATE orders SET status = 'SHIPPED' WHERE order_id = 1001;
```

**æ­¤æ—¶è¡¨çš„çŠ¶æ€ï¼š**

```
Table Metadata:
  next-row-id: 3 (æ²¡æœ‰æ–°å¢è¡Œï¼Œä¿æŒä¸å˜)

Snapshot 2 (sequence_number: 2):
  first-row-id: 3
  added-rows: 0 (UPDATE æ“ä½œä½¿ç”¨ position delete + insert)

æ•°æ®å†…å®¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_id â”‚ user_id â”‚ product_nameâ”‚ quantity â”‚ price    â”‚ status  â”‚ created_at          â”‚ _row_id â”‚ _last_updated_sequence_number    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1001     â”‚ 100     â”‚ iPhone 15   â”‚ 1        â”‚ 7999.00  â”‚ SHIPPED â”‚ 2024-01-15 10:00:00 â”‚ 0       â”‚ 2  â† æ›´æ–°äº†ï¼                    â”‚
â”‚ 1002     â”‚ 101     â”‚ MacBook Pro â”‚ 1        â”‚ 14999.00 â”‚ PENDING â”‚ 2024-01-15 10:05:00 â”‚ 1       â”‚ 1                                â”‚
â”‚ 1003     â”‚ 102     â”‚ AirPods Pro â”‚ 2        â”‚ 1999.00  â”‚ PENDING â”‚ 2024-01-15 10:10:00 â”‚ 2       â”‚ 1                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨æ„ï¼š_row_id ä¿æŒä¸º 0ï¼Œä½† _last_updated_sequence_number å˜æˆäº† 2
```

### 5.5 æ–°å¢è®¢å•

```sql
-- æ–°å¢ä¸¤ä¸ªè®¢å•
INSERT INTO orders VALUES
    (1004, 103, 'iPad Air', 1, 4799.00, 'PENDING', timestamp'2024-01-15 11:00:00'),
    (1005, 100, 'Apple Watch', 1, 3299.00, 'PENDING', timestamp'2024-01-15 11:05:00');
```

**æ­¤æ—¶è¡¨çš„çŠ¶æ€ï¼š**

```
Table Metadata:
  next-row-id: 5 (æ–°å¢äº†2è¡Œ)

Snapshot 3 (sequence_number: 3):
  first-row-id: 3
  added-rows: 2

æ•°æ®å†…å®¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_id â”‚ user_id â”‚ product_nameâ”‚ quantity â”‚ price    â”‚ status  â”‚ created_at          â”‚ _row_id â”‚ _last_updated_sequence_number    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1001     â”‚ 100     â”‚ iPhone 15   â”‚ 1        â”‚ 7999.00  â”‚ SHIPPED â”‚ 2024-01-15 10:00:00 â”‚ 0       â”‚ 2                                â”‚
â”‚ 1002     â”‚ 101     â”‚ MacBook Pro â”‚ 1        â”‚ 14999.00 â”‚ PENDING â”‚ 2024-01-15 10:05:00 â”‚ 1       â”‚ 1                                â”‚
â”‚ 1003     â”‚ 102     â”‚ AirPods Pro â”‚ 2        â”‚ 1999.00  â”‚ PENDING â”‚ 2024-01-15 10:10:00 â”‚ 2       â”‚ 1                                â”‚
â”‚ 1004     â”‚ 103     â”‚ iPad Air    â”‚ 1        â”‚ 4799.00  â”‚ PENDING â”‚ 2024-01-15 11:00:00 â”‚ 3       â”‚ 3  â† æ–°å¢è¡Œ                      â”‚
â”‚ 1005     â”‚ 100     â”‚ Apple Watch â”‚ 1        â”‚ 3299.00  â”‚ PENDING â”‚ 2024-01-15 11:05:00 â”‚ 4       â”‚ 3  â† æ–°å¢è¡Œ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.6 åˆ©ç”¨ Row Lineage è¿›è¡Œå¢é‡å¤„ç†

```sql
-- æŸ¥æ‰¾è‡ª sequence_number=2 ä¹‹åæœ‰å˜åŒ–çš„æ‰€æœ‰è¡Œ
SELECT 
    order_id,
    user_id,
    product_name,
    status,
    _row_id,
    _last_updated_sequence_number
FROM orders
WHERE _last_updated_sequence_number > 2;
```

**ç»“æœï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_id â”‚ user_id â”‚ product_nameâ”‚ status  â”‚ _row_id â”‚ _last_updated_sequence_number    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1004     â”‚ 103     â”‚ iPad Air    â”‚ PENDING â”‚ 3       â”‚ 3                                â”‚
â”‚ 1005     â”‚ 100     â”‚ Apple Watch â”‚ PENDING â”‚ 4       â”‚ 3                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åªè¿”å›äº†2è¡Œï¼Œè€Œä¸æ˜¯å…¨è¡¨æ‰«æï¼
```

### 5.7 è¿½è¸ªç‰¹å®šè¡Œçš„å˜æ›´

```sql
-- è¿½è¸ª _row_id=0 çš„è¡Œåœ¨ä¸åŒæ—¶é—´ç‚¹çš„çŠ¶æ€
-- ä½¿ç”¨ Time Travel ç»“åˆ Row Lineage

-- åœ¨ snapshot 1 æ—¶çš„çŠ¶æ€
SELECT * FROM orders VERSION AS OF 1 WHERE _row_id = 0;
-- ç»“æœ: status = 'PENDING', _last_updated_sequence_number = 1

-- åœ¨ snapshot 2 æ—¶çš„çŠ¶æ€  
SELECT * FROM orders VERSION AS OF 2 WHERE _row_id = 0;
-- ç»“æœ: status = 'SHIPPED', _last_updated_sequence_number = 2

-- å½“å‰çŠ¶æ€
SELECT * FROM orders WHERE _row_id = 0;
-- ç»“æœ: status = 'SHIPPED', _last_updated_sequence_number = 2
```

### 5.8 Compaction å Row Lineage ä¿æŒä¸å˜

```sql
-- æ‰§è¡Œ compaction
CALL system.rewrite_data_files('orders');
```

**Compaction åçš„æ•°æ®ï¼ˆRow Lineage ä¿æŒä¸å˜ï¼‰ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ order_id â”‚ user_id â”‚ product_nameâ”‚ quantity â”‚ price    â”‚ status  â”‚ created_at          â”‚ _row_id â”‚ _last_updated_sequence_number    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1001     â”‚ 100     â”‚ iPhone 15   â”‚ 1        â”‚ 7999.00  â”‚ SHIPPED â”‚ 2024-01-15 10:00:00 â”‚ 0       â”‚ 2  â† ä¿æŒä¸å˜ï¼                  â”‚
â”‚ 1002     â”‚ 101     â”‚ MacBook Pro â”‚ 1        â”‚ 14999.00 â”‚ PENDING â”‚ 2024-01-15 10:05:00 â”‚ 1       â”‚ 1  â† ä¿æŒä¸å˜ï¼                  â”‚
â”‚ 1003     â”‚ 102     â”‚ AirPods Pro â”‚ 2        â”‚ 1999.00  â”‚ PENDING â”‚ 2024-01-15 10:10:00 â”‚ 2       â”‚ 1  â† ä¿æŒä¸å˜ï¼                  â”‚
â”‚ 1004     â”‚ 103     â”‚ iPad Air    â”‚ 1        â”‚ 4799.00  â”‚ PENDING â”‚ 2024-01-15 11:00:00 â”‚ 3       â”‚ 3  â† ä¿æŒä¸å˜ï¼                  â”‚
â”‚ 1005     â”‚ 100     â”‚ Apple Watch â”‚ 1        â”‚ 3299.00  â”‚ PENDING â”‚ 2024-01-15 11:05:00 â”‚ 4       â”‚ 3  â† ä¿æŒä¸å˜ï¼                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è™½ç„¶æ•°æ®æ–‡ä»¶è¢«é‡å†™äº†ï¼Œä½† _row_id å’Œ _last_updated_sequence_number çš„å€¼ä¿æŒä¸å˜ï¼
```

### 5.9 å®ç°å¢é‡ç‰©åŒ–è§†å›¾

```sql
-- åˆ›å»ºä¸€ä¸ªç‰©åŒ–è§†å›¾ï¼šç”¨æˆ·è®¢å•æ±‡æ€»
CREATE TABLE user_order_summary (
    user_id BIGINT,
    total_orders INT,
    total_amount DECIMAL(12, 2),
    last_processed_seq BIGINT  -- è®°å½•æœ€åå¤„ç†çš„ sequence_number
) USING iceberg
TBLPROPERTIES ('format-version' = '3');

-- åˆå§‹å…¨é‡åŠ è½½
INSERT INTO user_order_summary
SELECT 
    user_id,
    COUNT(*) as total_orders,
    SUM(price * quantity) as total_amount,
    MAX(_last_updated_sequence_number) as last_processed_seq
FROM orders
GROUP BY user_id;

-- å¢é‡æ›´æ–°ï¼ˆåªå¤„ç†å˜åŒ–çš„æ•°æ®ï¼‰
MERGE INTO user_order_summary t
USING (
    SELECT 
        user_id,
        COUNT(*) as total_orders,
        SUM(price * quantity) as total_amount
    FROM orders
    WHERE _last_updated_sequence_number > (SELECT MAX(last_processed_seq) FROM user_order_summary)
    GROUP BY user_id
) s
ON t.user_id = s.user_id
WHEN MATCHED THEN UPDATE SET 
    t.total_orders = t.total_orders + s.total_orders,
    t.total_amount = t.total_amount + s.total_amount,
    t.last_processed_seq = (SELECT MAX(_last_updated_sequence_number) FROM orders)
WHEN NOT MATCHED THEN INSERT *;
```

---

## 6. ä½¿ç”¨åœºæ™¯

### 6.1 å˜æ›´æ•°æ®æ•è·ï¼ˆCDCï¼‰

```sql
-- æ¨¡æ‹Ÿ CDCï¼šè·å–è‡ªä¸Šæ¬¡åŒæ­¥ä»¥æ¥çš„æ‰€æœ‰å˜æ›´
SELECT 
    order_id,
    CASE 
        WHEN _last_updated_sequence_number = (SELECT MAX(sequence_number) FROM orders.snapshots)
        THEN 'UPSERT'
        ELSE 'UNCHANGED'
    END as change_type,
    *
FROM orders
WHERE _last_updated_sequence_number > @last_sync_sequence;
```

### 6.2 æ•°æ®å®¡è®¡

```sql
-- å®¡è®¡æŠ¥å‘Šï¼šå“ªäº›è¡Œåœ¨ç‰¹å®šæ—¶é—´èŒƒå›´å†…è¢«ä¿®æ”¹
SELECT 
    _row_id,
    order_id,
    status,
    _last_updated_sequence_number,
    s.committed_at as last_modified_time
FROM orders o
JOIN orders.snapshots s ON o._last_updated_sequence_number = s.sequence_number
WHERE s.committed_at BETWEEN '2024-01-15' AND '2024-01-16';
```

### 6.3 æ•°æ®è¡€ç¼˜è¿½è¸ª

```sql
-- è¿½è¸ªç‰¹å®šæ•°æ®çš„å®Œæ•´å˜æ›´å†å²
WITH row_history AS (
    SELECT 
        snap.sequence_number,
        snap.committed_at,
        o.*
    FROM orders.snapshots snap
    CROSS JOIN orders FOR SYSTEM_VERSION AS OF snap.snapshot_id o
    WHERE o._row_id = 0  -- è¿½è¸ª row_id=0 çš„è¡Œ
)
SELECT * FROM row_history ORDER BY sequence_number;
```

### 6.4 æ•°æ®è´¨é‡æ£€æŸ¥

```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰ row_id é‡å¤ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
SELECT _row_id, COUNT(*) as cnt
FROM orders
GROUP BY _row_id
HAVING COUNT(*) > 1;

-- ç»“æœåº”è¯¥ä¸ºç©º
```

---

## 7. é™åˆ¶ä¸æ³¨æ„äº‹é¡¹

### 7.1 Equality Deletes çš„é™åˆ¶

**é—®é¢˜**ï¼šä½¿ç”¨ Equality Deletes æ—¶ï¼ŒRow Lineage æ— æ³•æ­£ç¡®è¿½è¸ªã€‚

**åŸå› **ï¼š
- Equality Deletes ä¸è¯»å–ç°æœ‰æ•°æ®å°±ç›´æ¥åˆ é™¤
- å¼•æ“æ— æ³•è·å–åŸå§‹è¡Œçš„ `_row_id`
- è¢«è§†ä¸º"åˆ é™¤æ—§è¡Œ + æ’å…¥æ–°è¡Œ"

**ç¤ºä¾‹**ï¼š

```sql
-- ä½¿ç”¨ Equality Delete åˆ é™¤æ•°æ®ï¼ˆæŸäº›å¼•æ“åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å¯èƒ½ä½¿ç”¨ï¼‰
DELETE FROM orders WHERE status = 'CANCELLED';

-- é‡æ–°æ’å…¥"ç›¸åŒ"çš„æ•°æ®
INSERT INTO orders VALUES (1001, 100, 'iPhone 15', 1, 7999.00, 'REACTIVATED', ...);

-- ç»“æœï¼šè¿™æ¡æ–°æ•°æ®ä¼šè·å¾—æ–°çš„ _row_idï¼Œæ— æ³•ä¸åŸæ¥çš„è¡Œå…³è”
```

### 7.2 å†å²æ•°æ®ä¸ä¼šå›å¡«

å‡çº§åˆ° V3 åï¼š
- ç°æœ‰å¿«ç…§çš„ `first-row-id` ä¿æŒä¸º null
- å†å²æ•°æ®çš„ `_row_id` è¯»å–ä¸º null
- åªæœ‰æ–°æäº¤çš„æ•°æ®æ‰ä¼šæœ‰ Row Lineage

### 7.3 è·¨åˆ†æ”¯çš„ Row ID å¯èƒ½ä¸åŒ

```sql
-- åœ¨ main åˆ†æ”¯
INSERT INTO orders VALUES (...);  -- è·å¾— _row_id = 100

-- åœ¨ feature åˆ†æ”¯ï¼ˆä» main åˆ†å‰ï¼‰
INSERT INTO orders VALUES (...);  -- å¯èƒ½è·å¾— _row_id = 100ï¼ˆç›¸åŒå€¼ï¼ï¼‰

-- åˆå¹¶æ—¶éœ€è¦æ³¨æ„å†²çªå¤„ç†
```

### 7.4 æ€§èƒ½è€ƒè™‘

| æ“ä½œ | æ€§èƒ½å½±å“ |
|------|----------|
| å†™å…¥ | å‡ ä¹æ— å½±å“ï¼ˆåªæ˜¯å¤šå†™ä¸¤ä¸ª null å€¼ï¼‰ |
| è¯»å– | å‡ ä¹æ— å½±å“ï¼ˆç»§æ‰¿è®¡ç®—éå¸¸å¿«ï¼‰ |
| æäº¤ | ç•¥å¾®å¢åŠ ï¼ˆéœ€è¦ç»´æŠ¤ next-row-idï¼‰ |
| é‡è¯• | æ˜¾è‘—æ”¹å–„ï¼ˆæ— éœ€é‡å†™æ•°æ®æ–‡ä»¶ï¼‰ |

---

## 8. è¡¨å‡çº§æŒ‡å—

### 8.1 æ£€æŸ¥å½“å‰ç‰ˆæœ¬

```sql
-- æŸ¥çœ‹è¡¨çš„å½“å‰æ ¼å¼ç‰ˆæœ¬
DESCRIBE EXTENDED orders;
-- æˆ–
SELECT * FROM orders.metadata_log_entries;
```

### 8.2 å‡çº§åˆ° V3

```sql
-- å‡çº§è¡¨æ ¼å¼ç‰ˆæœ¬
ALTER TABLE orders SET TBLPROPERTIES ('format-version' = '3');
```

### 8.3 å‡çº§åçš„éªŒè¯

```sql
-- éªŒè¯ next-row-id å·²åˆå§‹åŒ–
SELECT * FROM orders.metadata_log_entries ORDER BY timestamp DESC LIMIT 1;

-- æŸ¥çœ‹ç°æœ‰å¿«ç…§ï¼ˆfirst-row-id åº”è¯¥ä¸º nullï¼‰
SELECT snapshot_id, first_row_id FROM orders.snapshots;

-- è¿›è¡Œä¸€æ¬¡ç©ºæäº¤è§¦å‘ Row ID åˆ†é…
CALL system.rewrite_data_files('orders', map('min-input-files', '9999'));

-- å†æ¬¡æŸ¥çœ‹ï¼ˆfirst-row-id åº”è¯¥æœ‰å€¼äº†ï¼‰
SELECT snapshot_id, first_row_id FROM orders.snapshots ORDER BY committed_at DESC LIMIT 1;
```

### 8.4 å‡çº§æ³¨æ„äº‹é¡¹

1. **ä¸å¯é€†æ“ä½œ**ï¼šå‡çº§åˆ° V3 åæ— æ³•é™çº§å› V2
2. **å¼•æ“å…¼å®¹æ€§**ï¼šç¡®ä¿æ‰€æœ‰è¯»å†™è¯¥è¡¨çš„å¼•æ“éƒ½æ”¯æŒ V3
3. **å†å²æ•°æ®**ï¼šå‡çº§ä¸ä¼šä¸ºå†å²æ•°æ®ç”Ÿæˆ Row Lineage
4. **æµ‹è¯•å»ºè®®**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

---

## 9. å¼•æ“æ”¯æŒ

### 9.1 æ”¯æŒçŠ¶æ€

| å¼•æ“ | V3 æ”¯æŒ | Row Lineage æ”¯æŒ | ç‰ˆæœ¬è¦æ±‚ |
|------|---------|------------------|----------|
| Apache Spark | âœ… | âœ… | 3.4+ with Iceberg 1.4+ |
| Apache Flink | âœ… | âœ… | 1.18+ with Iceberg 1.4+ |
| Trino | âœ… | âœ… | 433+ |
| Presto | ğŸ”„ | ğŸ”„ | è¿›è¡Œä¸­ |
| Dremio | âœ… | âœ… | 24.0+ |
| Snowflake | âœ… | âœ… | å·²æ”¯æŒ |
| Databricks | âœ… | âœ… | DBR 14.0+ |

### 9.2 Spark é…ç½®

```scala
// Spark Session é…ç½®
val spark = SparkSession.builder()
    .config("spark.sql.extensions", "org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions")
    .config("spark.sql.catalog.spark_catalog", "org.apache.iceberg.spark.SparkSessionCatalog")
    .config("spark.sql.catalog.spark_catalog.type", "hive")
    .getOrCreate()
```

### 9.3 Flink é…ç½®

```java
// Flink Table Environment é…ç½®
TableEnvironment tEnv = TableEnvironment.create(settings);
tEnv.executeSql("CREATE CATALOG iceberg_catalog WITH (" +
    "'type'='iceberg'," +
    "'catalog-type'='hive'," +
    "'uri'='thrift://localhost:9083'" +
    ")");
```

---

## 10. å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [Apache Iceberg Spec](https://iceberg.apache.org/spec/)
- [Iceberg V3 Release Notes](https://iceberg.apache.org/releases/)

### ç¤¾åŒºåšå®¢
- [Iceberg V3 - Starburst Blog](https://www.starburst.io/blog/iceberg-v3/)
- [AWS Blog - Iceberg V3 Deletion Vectors and Row Lineage](https://aws.amazon.com/blogs/big-data/accelerate-data-lake-operations-with-apache-iceberg-v3-deletion-vectors-and-row-lineage/)
- [Databricks Blog - Apache Iceberg V3](https://www.databricks.com/blog/apache-icebergtm-v3-moving-ecosystem-towards-unification)
- [Snowflake Blog - Apache Iceberg V3](https://www.snowflake.com/en/blog/apache-iceberg-v3-table-spec-oss-shared-success/)

### æºç å‚è€ƒ
- `core/src/main/java/org/apache/iceberg/MetadataColumns.java` - å…ƒæ•°æ®åˆ—å®šä¹‰
- `core/src/test/java/org/apache/iceberg/TestRowLineageMetadata.java` - å…ƒæ•°æ®æµ‹è¯•
- `core/src/test/java/org/apache/iceberg/TestRowLineageAssignment.java` - Row ID åˆ†é…æµ‹è¯•
- `spark/v4.1/spark/src/main/java/org/apache/iceberg/spark/source/ExtractRowLineage.java` - Spark é›†æˆ

---

## é™„å½•ï¼šå…ƒæ•°æ®å­—æ®µ ID å‚è€ƒ

```java
// æ¥è‡ª MetadataColumns.java
public static final int FILE_PATH_COLUMN_ID = Integer.MAX_VALUE - 1;      // 2147483646
public static final int ROW_POSITION_COLUMN_ID = Integer.MAX_VALUE - 2;   // 2147483645
public static final int IS_DELETED_COLUMN_ID = Integer.MAX_VALUE - 3;     // 2147483644
public static final int SPEC_ID_COLUMN_ID = Integer.MAX_VALUE - 4;        // 2147483643
public static final int PARTITION_COLUMN_ID = Integer.MAX_VALUE - 5;      // 2147483642
// ...
public static final int ROW_ID_COLUMN_ID = Integer.MAX_VALUE - 107;       // 2147483540
public static final int LAST_UPDATED_SEQ_NUM_ID = Integer.MAX_VALUE - 108; // 2147483539
```

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2026-01-19*  
*åŸºäº Apache Iceberg æœ€æ–°ä»£ç åº“*
