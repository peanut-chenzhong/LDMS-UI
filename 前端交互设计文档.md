# LDMS-UI 前端交互设计文档

## 1. 项目概述

### 1.1 项目简介
LDMS-UI 是一个基于 Angular 21 的 Hudi 表分析管理系统前端应用，提供三个核心功能页面：
- **风险列表页面** (Risk List)：展示和管理 Hudi 表的风险预警信息
- **表搜索页面** (Table Search)：查询和浏览表元数据信息，支持历史趋势分析
- **任务列表页面** (Task List)：管理和监控 Hudi 表分析任务的执行状态

### 1.2 技术栈
- **框架**: Angular 21 (Standalone Components)
- **语言**: TypeScript
- **样式**: SCSS (使用华为云设计变量)
- **图表库**: Chart.js + ng2-charts
- **Excel 导出**: XLSX

### 1.3 设计规范
- 遵循华为云设计规范
- 响应式布局设计
- 统一的交互模式和视觉风格

---

## 2. 页面结构总览

### 2.1 路由配置
```
/table-search  - 表搜索页面
/task-list     - 任务列表页面
/risk-list     - 风险列表页面
```

### 2.2 通用组件特性
- **分页控件**: 支持自定义每页显示数量（10/20/30/50/100），智能页码显示（超过7页时显示省略号）
- **搜索筛选**: 支持多条件组合筛选，实时过滤
- **排序功能**: 支持多列排序，点击表头切换升序/降序
- **响应式设计**: 适配不同屏幕尺寸

---

## 3. 风险列表页面 (Risk List)

### 3.1 页面功能概述
展示 Hudi 表的风险预警信息，支持多维度筛选、排序和分页浏览。

### 3.2 核心功能模块

#### 3.2.1 筛选栏 (Filter Bar)
**位置**: 页面顶部，表格上方

**筛选条件**:
1. **Database 筛选**
   - 输入框类型：文本输入框（支持模糊搜索）
   - 交互方式：
     - 输入时实时过滤下拉选项
     - 点击输入框或获得焦点时显示下拉列表
     - 支持键盘输入和鼠标选择
     - 点击外部区域自动关闭下拉框
   - 占位符：`选择或输入database`
   - 下拉箭头：显示 `▼` 图标

2. **TableName 筛选**
   - 输入框类型：文本输入框（支持模糊搜索）
   - 交互方式：同 Database 筛选
   - 占位符：`选择或输入表名`

3. **风险类型筛选**
   - 输入框类型：下拉选择框
   - 选项列表：
     - `全部类型` (空值)
     - `元数据膨胀` (metadata_bloat)
     - `schema膨胀` (schema_bloat)
     - `compaction积压` (compaction_backlog)
     - `compaction异常` (compaction_abnormal)
     - `clean异常` (clean_abnormal)
     - `archive异常` (archive_abnormal)

**操作按钮**:
- **Search 按钮**: 执行筛选，重置到第一页
- **Reset 按钮**: 清空所有筛选条件，恢复默认状态

#### 3.2.2 数据表格 (Data Table)

**表格列**:
1. **数据库名** (database)
   - 列宽：自适应
   - 排序：不支持

2. **表名** (tablename)
   - 列宽：自适应
   - 排序：不支持

3. **风险类型** (riskType)
   - 显示方式：徽章样式
   - 样式分类：
     - `risk-warning` (黄色)：元数据膨胀、schema膨胀、compaction积压
     - `risk-error` (红色)：compaction异常、clean异常、archive异常
   - 排序：不支持

4. **预警时间** (alertTime)
   - 格式：`YYYY-MM-DD HH:mm:ss`
   - 排序：**支持排序**（点击表头切换升序/降序）
   - 排序图标：
     - 未排序：显示 `↕`
     - 升序：显示 `↑`
     - 降序：显示 `↓`
   - 列宽：160px，不换行

5. **原因** (reason)
   - 列宽：自适应
   - 排序：不支持

**交互行为**:
- 点击"预警时间"列头可切换排序方向
- 空数据时显示：`暂无风险数据`

#### 3.2.3 分页控件 (Pagination)

**显示内容**:
- 左侧：总数据量 `Total X items`，每页条数选择器
- 右侧：页码按钮（Prev/页码/Next）

**交互规则**:
- 页码显示逻辑：
  - 总页数 ≤ 7：显示所有页码
  - 总页数 > 7：显示 `1 ... [当前页-1] [当前页] [当前页+1] ... [总页数]`
- 按钮状态：
  - 第一页时，`Prev` 按钮禁用
  - 最后一页时，`Next` 按钮禁用
  - 当前页高亮显示

### 3.3 数据流

```
用户输入筛选条件
    ↓
onSearch() 触发
    ↓
filterRisks() 执行过滤
    ↓
applySort() 应用排序（如果已设置）
    ↓
更新 filteredRisks
    ↓
分页计算 paginatedRisks
    ↓
渲染表格
```

### 3.4 交互细节

#### 3.4.1 模糊搜索下拉框
**触发时机**:
- 输入框获得焦点 (`focus` 事件)
- 输入内容变化 (`input` 事件)

**过滤逻辑**:
```typescript
filteredDatabases = allDatabases.filter(db => 
  db.toLowerCase().includes(keyword.toLowerCase())
);
```

**关闭时机**:
- 点击下拉选项
- 点击页面其他区域（通过 `@HostListener('document:click')` 监听）

#### 3.4.2 排序功能
**排序规则**:
- 预警时间：按日期时间戳排序
- 字符串字段：使用 `localeCompare` 进行本地化排序

**状态管理**:
- `sortField`: 当前排序字段
- `sortDirection`: 排序方向 ('asc' | 'desc')

**切换逻辑**:
- 首次点击：设置为升序
- 再次点击同一列：切换为降序
- 点击其他列：重置为升序

---

## 4. 表搜索页面 (Table Search)

### 4.1 页面功能概述
查询和浏览 Hudi 表的元数据信息，支持列拖拽排序、行选择查看历史趋势图表。

### 4.2 核心功能模块

#### 4.2.1 筛选栏 (Filter Bar)

**筛选条件**:
1. **Database 筛选**
   - 输入框类型：文本输入框（支持模糊搜索）
   - 交互方式：同风险列表页面的 Database 筛选

2. **TableName 筛选**
   - 输入框类型：文本输入框（支持模糊搜索）
   - 交互方式：同风险列表页面的 TableName 筛选

**操作按钮**:
- **Search 按钮**: 执行筛选
- **Reset 按钮**: 清空筛选条件，取消选中行，关闭图表

#### 4.2.2 数据表格 (Data Table)

**表格结构**:
- **固定列**（不可拖拽，左侧固定）:
  1. `database` - 数据库名
  2. `tablename` - 表名
  3. `createtime` - 创建时间
  4. `tabletype` - 表类型 (COW/MOR/MOW)

- **可拖拽列**（支持拖拽排序和列排序）:
  1. `tablesize` - 表大小（支持排序）
  2. `filenumber` - 文件数（支持排序）
  3. `tableindex` - 表索引（支持排序）
  4. `lastcommittime` - 最后提交时间（支持排序）
  5. `lastcompletecompactiontime` - 最后完成compaction时间（支持排序）
  6. `lastcleantime` - 最后清理时间（支持排序）
  7. `archivelogsize` - 归档日志大小（支持排序）
  8. `schemaversion` - Schema版本（支持排序）
  9. `updatatime` - 更新时间（支持排序）

**交互功能**:

1. **列拖拽排序**
   - 拖拽手柄：列头显示 `⋮⋮` 图标
   - 拖拽状态：
     - `dragIndex`: 当前拖拽的列索引
     - `dragOverIndex`: 拖拽经过的列索引（高亮显示）
   - 拖拽事件：
     - `dragstart`: 开始拖拽
     - `dragover`: 拖拽经过（阻止默认行为，设置 `dropEffect = 'move'`）
     - `drop`: 放置列（交换列位置）
     - `dragend`: 结束拖拽（重置状态）

2. **列排序**
   - 仅可拖拽列支持排序
   - 点击列头切换升序/降序
   - 排序图标显示在列头右侧

3. **行选择**
   - 点击表格行选中/取消选中
   - 选中行高亮显示（`.selected` 类）
   - 选中行后自动生成历史趋势图表

#### 4.2.3 历史趋势图表 (Chart Section)

**显示条件**: 选中表格行后显示

**图表内容**:
- **标题**: `{database}.{tablename} - 30天趋势`
- **关闭按钮**: 右上角 `✕` 按钮，点击后取消选中行

**图表数据** (30天历史数据):
1. **表大小** (tablesize) - 蓝色线条
2. **文件数** (filenumber) - 绿色线条
3. **未完成commit数** (uncommittedCount) - 红色线条
4. **active commit数** (activeCommitCount) - 紫色线条
5. **rollback数** (rollbackCount) - 粉色线条
6. **schema版本** (schemaversion) - 灰色虚线

**图表配置**:
- 类型：折线图 (Line Chart)
- 交互模式：`index`（鼠标悬停显示所有数据点）
- 图例：顶部显示，使用点样式
- 工具提示：白色背景，自定义样式
- 响应式：自适应容器大小

**数据生成逻辑**:
```typescript
// 基于选中行的基础值，生成30天波动数据
for (let i = 29; i >= 0; i--) {
  // 使用正弦波和随机数模拟数据波动
  const dayVariation = Math.sin(i * 0.3) * 0.1 + (Math.random() - 0.5) * 0.05;
  // 生成每日数据点
}
```

### 4.3 数据流

```
用户输入筛选条件
    ↓
onSearch() 触发
    ↓
filteredData 更新
    ↓
applySort() 应用排序（如果已设置）
    ↓
分页计算 paginatedData
    ↓
渲染表格
    ↓
用户点击行
    ↓
onRowSelect() 触发
    ↓
generateHistoryData() 生成30天数据
    ↓
updateChartData() 更新图表
    ↓
显示图表区域
```

### 4.4 交互细节

#### 4.4.1 列拖拽实现
**HTML5 Drag and Drop API**:
- 使用原生 `draggable="true"` 属性
- 通过 `dataTransfer` 传递拖拽数据
- 拖拽过程中显示视觉反馈（`.drag-over` 类）

**列位置交换逻辑**:
```typescript
onDrop(event: DragEvent, targetIndex: number): void {
  const column = draggableColumns[dragIndex];
  draggableColumns.splice(dragIndex, 1);
  draggableColumns.splice(targetIndex, 0, column);
}
```

#### 4.4.2 排序功能
**排序规则**:
- 数字类型：直接数值比较
- 字符串类型：使用 `localeCompare` 本地化排序

---

## 5. 任务列表页面 (Task List)

### 5.1 页面功能概述
管理和监控 Hudi 表分析任务的执行状态，支持任务创建、启动、停止、删除、查看报告，以及执行历史记录查看。

### 5.2 核心功能模块

#### 5.2.1 操作栏 (Action Bar)
**位置**: 页面顶部，筛选栏上方

**功能按钮**:
- **新增任务按钮** (`+ 新增任务`)
  - 点击打开"新增分析任务"模态框
  - 按钮样式：主色调，带加号图标

#### 5.2.2 筛选栏 (Filter Bar)

**筛选条件**:
1. **任务状态筛选**
   - 输入框类型：下拉选择框
   - 选项列表：
     - `全部状态` (空值)
     - `待执行` (pending)
     - `运行中` (running)
     - `已完成` (completed)
     - `失败` (failed)
     - `已停止` (stopped)
   - 交互：选择后自动触发筛选

2. **任务名搜索**
   - 输入框类型：文本输入框
   - 功能：模糊搜索任务名称
   - 占位符：`输入任务名搜索`
   - 触发：按 Enter 键或点击 Search 按钮

3. **Database 筛选**
   - 输入框类型：文本输入框（支持模糊搜索）
   - 交互方式：同其他页面的 Database 筛选
   - 筛选逻辑：检查任务的表列表中是否包含匹配的数据库

4. **TableName 筛选**
   - 输入框类型：文本输入框（支持模糊搜索）
   - 交互方式：同其他页面的 TableName 筛选
   - 筛选逻辑：检查任务的表列表中是否包含匹配的表名

**操作按钮**:
- **Search 按钮**: 执行筛选
- **Reset 按钮**: 清空所有筛选条件

#### 5.2.3 数据表格 (Data Table)

**表格列**:
1. **任务名** (taskName)
   - 显示：用户自定义的任务名称
   - 排序：不支持

2. **创建时间** (createTime)
   - 格式：`YYYY-MM-DD HH:mm:ss`
   - 排序：**支持排序**

3. **任务状态** (status)
   - 显示方式：状态徽章
   - 状态样式：
     - `status-pending` (灰色)：待执行
     - `status-running` (蓝色)：运行中
     - `status-completed` (绿色)：已完成
     - `status-failed` (红色)：失败
     - `status-stopped` (橙色)：已停止
   - 排序：**支持排序**（使用预定义顺序）

4. **表数量** (tableCount)
   - 显示：任务包含的表数量
   - 交互：点击数字可查看表列表（打开模态框）
   - 排序：**支持排序**

5. **开始时间** (startTime)
   - 格式：`YYYY-MM-DD HH:mm:ss` 或 `-`
   - 排序：**支持排序**

6. **完成时间** (endTime)
   - 格式：`YYYY-MM-DD HH:mm:ss` 或 `-`
   - 排序：**支持排序**

7. **任务 AppID** (appId)
   - 显示：Spark 应用 ID 或 `-`
   - 交互：鼠标悬停显示完整 ID（如果过长）

8. **操作** (actions)
   - 按钮组：
     - **查看报告**：仅当任务状态为 `completed` 时可用
     - **启动**：当任务状态为 `stopped`、`failed` 或 `completed` 时显示
     - **停止**：当任务状态为 `pending` 或 `running` 时显示
     - **删除**：当任务状态不为 `running` 时可用

**行展开功能**:
- 点击任务行可展开/收起执行历史记录
- 展开状态通过 `expandedTaskId` 管理
- 展开后显示子列表，包含所有执行记录

#### 5.2.4 执行历史记录子列表 (Execution List)

**显示位置**: 任务行下方（展开后）

**显示内容** (每条执行记录):
1. **任务 AppID**: `execution.appId`
2. **开始时间**: `execution.startTime`
3. **完成时间**: `execution.endTime`
4. **状态**: 状态徽章（同主列表）
5. **操作按钮**:
   - **查看报告**：仅当执行记录状态为 `completed` 时显示

**交互规则**:
- 执行记录按时间倒序排列（最新的在前）
- 每个任务可以有 1-5 条执行记录
- 主列表显示的是最新执行记录的状态和信息

#### 5.2.5 表列表模态框 (Tables Modal)

**触发方式**: 点击任务行的"表数量"数字

**显示内容**:
- 模态框标题：`分析表列表`
- 任务名称：显示当前任务名
- 表列表：显示所有分析表的完整名称（`database.tablename`）
- 列表格式：序号 + 表名

**交互**:
- 点击遮罩层或关闭按钮关闭模态框

#### 5.2.6 新增任务模态框 (Create Task Modal)

**触发方式**: 点击"新增任务"按钮

**表单字段**:

1. **任务名称** (必填)
   - 输入框类型：文本输入框
   - 占位符：`请输入任务名称`
   - 最大长度：100 字符
   - 验证：提交时不能为空

2. **分析项选择**
   - 复选框组：
     - `compaction分析`
     - `clean分析`
     - `archive分析`
   - 分区存储分析（带模式选择）：
     - 复选框：`分区存储分析`
     - 模式选择下拉框（启用后可用）：
       - `从最近compaction扫描` (recent_compaction)
       - `全表扫描` (full_scan)
       - `从指定commit时间扫描` (specified_commit)
     - 指定commit时间输入框（当模式为 `specified_commit` 时显示）：
       - 格式：`yyyyMMddHHmmssSSS` (17位数字)
       - 占位符：`yyyyMMddHHmmssSSS`
       - 验证：必须为17位数字

3. **数据库选择**
   - 输入框类型：下拉选择框
   - 选项：从 `databaseTables` 映射中获取
   - 占位符：`请选择数据库`
   - 验证：提交时必须选择

4. **表选择**
   - 显示条件：选择数据库后显示
   - 功能：
     - **全选/取消全选按钮**：切换所有表的选中状态
     - **表搜索框**：实时过滤表列表
     - **表复选框列表**：多选表
     - **已选择计数**：显示 `已选择 X / Y 张表`
   - 验证：提交时至少选择一张表

**提交验证**:
1. 至少选择一个分析项
2. 任务名称不能为空
3. 如果选择"从指定commit时间扫描"，必须输入17位时间戳
4. 必须选择数据库
5. 至少选择一张表

**提交后行为**:
- 创建新任务，添加到任务列表顶部
- 关闭模态框
- 显示成功提示（任务名、分析项、表数量）
- 自动刷新筛选结果

#### 5.2.7 查看报告功能 (View Report)

**触发方式**:
- 主列表：点击"查看报告"按钮（任务状态为 `completed`）
- 执行记录：点击子列表中的"查看报告"按钮（执行记录状态为 `completed`）

**Excel 文件结构**:

1. **第一个 Sheet: `risk list`** (固定)
   - 列：
     - `database` - 数据库名
     - `tablename` - 表名
     - `风险类型` - 固定显示两种：
       - `数据倾斜`
       - `log文件过大`
     - `分析结果` - 随机生成的分析结果文本
   - 数据：每个表生成两条记录（两种风险类型各一条）

2. **后续 Sheet: 每个分析项一个 Sheet**
   - Sheet 名称：分析项名称（去掉"分析"后缀）
   - 列：
     - `database` - 数据库名
     - `tablename` - 表名
     - `result` - 分析结果文本
   - 数据：每个表一条记录

**文件命名规则**:
```
analysis_report_{任务名前8位}_{当前日期}.xlsx
```

**列宽设置**:
- database: 20 字符
- tablename: 30 字符
- 风险类型/分析结果: 60 字符

#### 5.2.8 任务操作功能

**启动任务** (`startTask`):
- **显示条件**: 任务状态为 `stopped`、`failed` 或 `completed`
- **交互**: 点击后弹出确认对话框
- **行为**:
  - 创建新的执行记录（状态：`pending`）
  - 更新任务主状态为 `pending`
  - 重置开始时间、完成时间、AppID 为 `-`

**停止任务** (`stopTask`):
- **显示条件**: 任务状态为 `pending` 或 `running`
- **交互**: 点击后弹出确认对话框
- **行为**:
  - 更新最新执行记录状态为 `stopped`
  - 更新任务主状态为 `stopped`
  - 设置完成时间为当前时间

**删除任务** (`deleteTask`):
- **可用条件**: 任务状态不为 `running`
- **交互**: 点击后弹出确认对话框（提示不可恢复）
- **行为**:
  - 从任务列表中移除
  - 自动刷新筛选结果

### 5.3 数据流

#### 5.3.1 任务筛选流程
```
用户输入筛选条件
    ↓
onSearch() 或 onStatusFilterChange() 触发
    ↓
filterTasks() 执行多条件过滤
    ↓
applySort() 应用排序（如果已设置）
    ↓
更新 filteredTasks
    ↓
分页计算 paginatedTasks
    ↓
渲染表格
```

#### 5.3.2 任务创建流程
```
用户点击"新增任务"
    ↓
打开模态框，重置表单
    ↓
用户填写表单
    ↓
submitCreateTask() 验证
    ↓
创建 AnalysisTask 对象
    ↓
添加到 allTasks 列表顶部
    ↓
filterTasks() 刷新筛选
    ↓
关闭模态框，显示成功提示
```

#### 5.3.3 报告生成流程
```
用户点击"查看报告"
    ↓
viewReport() 或 viewReportForExecution()
    ↓
创建工作簿 (workbook)
    ↓
创建 "risk list" Sheet（固定第一个）
    ↓
为每个分析项创建 Sheet
    ↓
生成文件名
    ↓
XLSX.writeFile() 下载文件
```

### 5.4 交互细节

#### 5.4.1 行展开/收起
**实现方式**:
- 点击任务行触发 `toggleTaskRow()`
- 通过 `expandedTaskId` 管理展开状态
- 使用 `@if (isTaskExpanded(task))` 条件渲染子列表

**事件冒泡控制**:
- 操作按钮添加 `(click)="$event.stopPropagation()"` 防止触发行展开
- 表数量点击也添加 `stopPropagation()`

#### 5.4.2 按钮互斥逻辑
**启动/停止按钮**:
```typescript
canStart(task): boolean {
  return task.status === 'stopped' || 
         task.status === 'failed' || 
         task.status === 'completed';
}

canStop(task): boolean {
  return task.status === 'pending' || 
         task.status === 'running';
}
```

**显示规则**:
- 如果 `canStart(task)` 为 `true`，显示"启动"按钮
- 如果 `canStop(task)` 为 `true`，显示"停止"按钮
- 两个按钮互斥，不会同时显示

#### 5.4.3 执行记录管理
**数据结构**:
```typescript
interface TaskExecution {
  id: string;
  startTime: string;
  endTime: string;
  appId: string;
  status: 'pending' | 'running' | 'completed' | 'failed' | 'stopped';
}

interface AnalysisTask {
  // ... 其他字段
  executions: TaskExecution[];  // 执行历史记录
}
```

**主列表与执行记录的关系**:
- 主列表显示的是最新执行记录（`executions[0]`）的状态和信息
- 执行记录按时间倒序排列（最新的在前）
- 启动任务时，创建新的执行记录并添加到 `executions` 数组开头

---

## 6. 通用交互模式

### 6.1 分页控件

**通用特性**:
- 左侧显示总数据量
- 每页条数选择器（10/20/30/50/100）
- 智能页码显示（超过7页显示省略号）
- Prev/Next 按钮，首末页自动禁用

**交互规则**:
- 切换每页条数时，重置到第一页
- 筛选/排序时，重置到第一页

### 6.2 模糊搜索下拉框

**通用实现**:
- 输入框 + 下拉箭头 + 下拉列表
- 实时过滤选项
- 点击外部关闭
- 支持键盘输入和鼠标选择

**样式类**:
- `.search-dropdown-container`: 容器
- `.filter-input-dropdown`: 输入框
- `.dropdown-arrow`: 下拉箭头
- `.search-dropdown`: 下拉列表
- `.dropdown-item`: 下拉选项
- `.selected`: 当前选中项高亮

### 6.3 排序功能

**通用实现**:
- 可排序列显示排序图标 `↕`
- 点击切换升序 `↑` / 降序 `↓`
- 排序状态通过 `.active` 类高亮

**排序规则**:
- 数字：直接数值比较
- 字符串：`localeCompare` 本地化排序
- 日期时间：转换为时间戳比较
- 特殊值（如 `-`）：在排序时特殊处理

### 6.4 模态框

**通用特性**:
- 遮罩层（`.modal-overlay`）
- 居中内容区域（`.modal-content`）
- 标题栏 + 关闭按钮
- 点击遮罩层关闭（通过 `stopPropagation` 防止内容区域点击关闭）

**样式类**:
- `.modal-overlay`: 遮罩层
- `.modal-content`: 内容区域
- `.modal-header`: 标题栏
- `.modal-title`: 标题
- `.modal-close`: 关闭按钮
- `.modal-body`: 内容区域
- `.modal-footer`: 底部按钮区域

---

## 7. 数据模型

### 7.1 风险项 (RiskItem)
```typescript
interface RiskItem {
  id: string;                    // 风险ID
  database: string;              // 数据库名
  tablename: string;            // 表名
  riskType: string;             // 风险类型（显示文本）
  alertTime: string;             // 预警时间 (YYYY-MM-DD HH:mm:ss)
  reason: string;               // 风险原因描述
}
```

### 7.2 表行数据 (TableRow)
```typescript
interface TableRow {
  database: string;              // 数据库名
  tablename: string;            // 表名
  createtime: string;           // 创建时间
  tabletype: string;             // 表类型 (COW/MOR/MOW)
  tablesize: number;            // 表大小
  filenumber: number;           // 文件数
  tableindex: string;           // 表索引
  lastcommittime: string;       // 最后提交时间
  lastcompletecompactiontime: string;  // 最后完成compaction时间
  lastcleantime: string;        // 最后清理时间
  archivelogsize: number;       // 归档日志大小
  schemaversion: number;        // Schema版本
  updatatime: string;          // 更新时间
}
```

### 7.3 任务执行记录 (TaskExecution)
```typescript
interface TaskExecution {
  id: string;                   // 执行记录ID
  startTime: string;            // 开始时间 (YYYY-MM-DD HH:mm:ss 或 '-')
  endTime: string;              // 完成时间 (YYYY-MM-DD HH:mm:ss 或 '-')
  appId: string;                // Spark应用ID 或 '-'
  status: 'pending' | 'running' | 'completed' | 'failed' | 'stopped';
}
```

### 7.4 分析任务 (AnalysisTask)
```typescript
interface AnalysisTask {
  id: string;                   // 任务ID
  taskName: string;             // 任务名称（用户自定义）
  createTime: string;           // 创建时间 (YYYY-MM-DD HH:mm:ss)
  status: 'pending' | 'running' | 'completed' | 'failed' | 'stopped';
  tables: string[];             // 分析表列表 (格式: 'database.tablename')
  startTime: string;            // 开始时间 (YYYY-MM-DD HH:mm:ss 或 '-')
  endTime: string;              // 完成时间 (YYYY-MM-DD HH:mm:ss 或 '-')
  appId: string;                // 任务AppID 或 '-'
  analysisTypes: string[];      // 分析项列表
  executions: TaskExecution[];   // 执行历史记录
}
```

### 7.5 历史数据 (HistoryData)
```typescript
interface HistoryData {
  date: string;                 // 日期 (MM/DD)
  tablesize: number;           // 表大小
  filenumber: number;          // 文件数
  uncommittedCount: number;    // 未完成commit数
  activeCommitCount: number;   // active commit数
  rollbackCount: number;       // rollback数
  schemaversion: number;       // schema版本
}
```

---

## 8. 状态管理

### 8.1 组件状态变量

#### 风险列表页面
- `allRisks`: 所有风险数据
- `filteredRisks`: 筛选后的风险数据
- `currentPage`: 当前页码
- `pageSize`: 每页条数
- `sortField`: 排序字段
- `sortDirection`: 排序方向
- `searchDatabase`: Database 搜索关键词
- `searchTableName`: TableName 搜索关键词
- `searchRiskType`: 风险类型筛选值
- `showDatabaseDropdown`: Database 下拉框显示状态
- `showTableNameDropdown`: TableName 下拉框显示状态

#### 表搜索页面
- `allData`: 所有表数据
- `filteredData`: 筛选后的表数据
- `selectedRow`: 当前选中的行
- `historyData`: 历史趋势数据
- `draggableColumns`: 可拖拽列配置
- `dragIndex`: 当前拖拽的列索引
- `dragOverIndex`: 拖拽经过的列索引
- `sortField`: 排序字段
- `sortDirection`: 排序方向

#### 任务列表页面
- `allTasks`: 所有任务数据
- `filteredTasks`: 筛选后的任务数据
- `expandedTaskId`: 当前展开的任务ID
- `showCreateModal`: 新增任务模态框显示状态
- `showTablesModal`: 表列表模态框显示状态
- `statusFilter`: 状态筛选值
- `searchTaskName`: 任务名搜索关键词
- `searchDatabase`: Database 搜索关键词
- `searchTableName`: TableName 搜索关键词
- `newTaskName`: 新任务名称
- `selectedDatabase`: 选中的数据库
- `selectedTables`: 选中的表列表

### 8.2 状态流转

#### 任务状态流转
```
pending → running → completed
                ↓
            failed / stopped
                ↓
         (可重新启动) → pending
```

#### 执行记录状态流转
```
pending → running → completed
                ↓
            failed / stopped
```

---

## 9. 错误处理与验证

### 9.1 表单验证

#### 新增任务表单
1. **任务名称验证**
   - 必填
   - 不能为空字符串或仅空格

2. **分析项验证**
   - 至少选择一个分析项

3. **Commit时间戳验证**
   - 当选择"从指定commit时间扫描"时必填
   - 格式：17位数字 (`yyyyMMddHHmmssSSS`)
   - 正则：`/^\d{17}$/`

4. **数据库验证**
   - 必选

5. **表选择验证**
   - 至少选择一张表

### 9.2 用户提示

**提示方式**:
- `alert()`: 用于错误提示和确认对话框
- 按钮禁用状态：通过 `[disabled]` 和 `.disabled` 类

**确认对话框**:
- 启动任务：`确定要启动任务 "{taskName}" 吗？`
- 停止任务：`确定要停止任务 "{taskName}" 吗？`
- 删除任务：`确定要删除任务 "{taskName}" 吗？此操作不可恢复。`

---

## 10. 性能优化建议

### 10.1 数据加载
- 当前使用模拟数据，实际项目中应使用分页 API
- 建议实现虚拟滚动（如果数据量很大）

### 10.2 图表渲染
- Chart.js 图表在数据更新时自动重绘
- 建议对大数据集进行采样或聚合

### 10.3 列表渲染
- 使用 Angular 的 `@for` 和 `track` 优化列表渲染
- 分页减少单次渲染的数据量

---

## 11. 浏览器兼容性

### 11.1 支持的浏览器
- Chrome (最新版本)
- Firefox (最新版本)
- Edge (最新版本)
- Safari (最新版本)

### 11.2 使用的现代特性
- HTML5 Drag and Drop API（列拖拽）
- ES6+ 语法（箭头函数、解构、模板字符串等）
- CSS Grid / Flexbox（布局）

---

## 12. 后续优化方向

### 12.1 功能增强
1. **实时数据更新**: 使用 WebSocket 或轮询更新任务状态
2. **批量操作**: 支持批量启动/停止/删除任务
3. **任务调度**: 支持定时任务和任务依赖
4. **数据导出**: 支持导出筛选后的数据为 CSV/Excel
5. **图表交互**: 支持图表缩放、数据点详情查看

### 12.2 用户体验优化
1. **加载状态**: 添加加载动画和骨架屏
2. **错误提示**: 使用 Toast 消息替代 `alert()`
3. **快捷键支持**: 支持键盘快捷键操作
4. **操作历史**: 记录用户操作历史，支持撤销/重做

### 12.3 技术优化
1. **状态管理**: 引入 NgRx 或 Akita 进行全局状态管理
2. **API 集成**: 替换模拟数据为真实 API 调用
3. **单元测试**: 增加组件和服务的单元测试
4. **E2E 测试**: 使用 Cypress 或 Playwright 进行端到端测试

---

## 附录 A: 关键代码片段

### A.1 模糊搜索实现
```typescript
onDatabaseInputChange(): void {
  const keyword = this.searchDatabase.toLowerCase().trim();
  if (keyword) {
    this.filteredDatabases = this.allDatabases.filter(db => 
      db.toLowerCase().includes(keyword)
    );
  } else {
    this.filteredDatabases = [...this.allDatabases];
  }
  this.showDatabaseDropdown = true;
}
```

### A.2 列拖拽实现
```typescript
onDrop(event: DragEvent, targetIndex: number): void {
  event.preventDefault();
  if (this.dragIndex !== -1 && this.dragIndex !== targetIndex) {
    const column = this.draggableColumns[this.dragIndex];
    this.draggableColumns.splice(this.dragIndex, 1);
    this.draggableColumns.splice(targetIndex, 0, column);
  }
  this.dragIndex = -1;
  this.dragOverIndex = -1;
}
```

### A.3 Excel 导出实现
```typescript
viewReport(task: AnalysisTask): void {
  const workbook = XLSX.utils.book_new();
  
  // 创建 risk list sheet
  const riskListData = task.tables.map(fullTableName => {
    const [database, tablename] = fullTableName.split('.');
    return {
      database,
      tablename,
      '风险类型': '数据倾斜',
      '分析结果': this.generateRiskAnalysisResult('数据倾斜')
    };
  });
  
  const riskListWorksheet = XLSX.utils.json_to_sheet(riskListData);
  XLSX.utils.book_append_sheet(workbook, riskListWorksheet, 'risk list');
  
  // 为每个分析项创建 sheet
  task.analysisTypes.forEach(analysisType => {
    // ... 创建其他 sheet
  });
  
  const fileName = `analysis_report_${task.taskName.slice(0, 8)}_${new Date().toISOString().slice(0, 10)}.xlsx`;
  XLSX.writeFile(workbook, fileName);
}
```

---

## 附录 B: 样式类参考

### B.1 状态徽章类
- `.status-pending`: 待执行（灰色）
- `.status-running`: 运行中（蓝色）
- `.status-completed`: 已完成（绿色）
- `.status-failed`: 失败（红色）
- `.status-stopped`: 已停止（橙色）

### B.2 风险徽章类
- `.risk-warning`: 警告级别（黄色）- 元数据膨胀、schema膨胀、compaction积压
- `.risk-error`: 错误级别（红色）- compaction异常、clean异常、archive异常

### B.3 按钮类
- `.btn-primary`: 主要按钮（蓝色）
- `.btn-secondary`: 次要按钮（灰色）
- `.btn-create`: 创建按钮（带加号图标）
- `.btn-action`: 操作按钮
- `.btn-view`: 查看按钮
- `.btn-start`: 启动按钮（绿色）
- `.btn-stop`: 停止按钮（红色）
- `.btn-delete`: 删除按钮（红色）
- `.disabled`: 禁用状态

---

## 文档版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024-12 | 初始版本，包含三个页面的完整交互设计文档 | - |

---

**文档结束**
